<!doctype html>
<html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><base href="../"/><link href="css/built.css?0917b4" rel="stylesheet"/><title>Reagent: A binary clock</title></head><body><div id="main-content"><div><div data-reactroot=""><div class="nav"><ul class="nav"><li class="brand"><a href="index.html">Reagent:</a></li><li><a href="index.html">Intro</a></li><li><a href="news/index.html">News</a></li><li><a href="https://github.com/reagent-project/reagent">GitHub</a></li><li><a href="http://reagent-project.github.io/docs/master/">API</a></li></ul></div><div></div><div class="reagent-demo"><h1><a href="news/binary-clock.html">A binary clock</a></h1><span>2014-02-26</span><div class="demo-text"><div><div class="clearfix"><div class="clock-main"><div class="clock-col clock-legend"><div class="clock-cell">8</div><div class="clock-cell">4</div><div class="clock-cell">2</div><div class="clock-cell">1</div></div><div class="clock-pair"><div class="clock-col"><div class="clock-cell dark"></div><div class="clock-cell dark"></div><div class="clock-cell dark"></div><div class="clock-cell light"></div><div class="clock-cell">1</div></div><div class="clock-col"><div class="clock-cell dark"></div><div class="clock-cell light"></div><div class="clock-cell light"></div><div class="clock-cell dark"></div><div class="clock-cell">6</div></div></div><div class="clock-pair"><div class="clock-col"><div class="clock-cell dark"></div><div class="clock-cell light"></div><div class="clock-cell dark"></div><div class="clock-cell light"></div><div class="clock-cell">5</div></div><div class="clock-col"><div class="clock-cell dark"></div><div class="clock-cell dark"></div><div class="clock-cell dark"></div><div class="clock-cell light"></div><div class="clock-cell">1</div></div></div><div class="clock-pair"><div class="clock-col"><div class="clock-cell dark"></div><div class="clock-cell dark"></div><div class="clock-cell dark"></div><div class="clock-cell light"></div><div class="clock-cell">1</div></div><div class="clock-col"><div class="clock-cell dark"></div><div class="clock-cell light"></div><div class="clock-cell light"></div><div class="clock-cell dark"></div><div class="clock-cell">6</div></div></div></div></div><div><strong>Click to toggle 1/100th seconds.</strong></div></div><p>Fredrik Dyrkell wrote a very nice <a href="http://www.lexicallyscoped.com/2014/01/23/clojurescript-react-om-binary-clock.html">binary
      clock</a> using <a href="https://github.com/swannodette/om">Om</a>. I thought I’d replicate that
      using Reagent for fun (another re-write, using <a href="http://hoplon.io">Hoplon</a>, can be seen <a href="http://pmbauer.github.io/2014/01/27/hoplon-binary-clock/">here</a>).</p><p>So, without further ado, here is a binary clock using Reagent.</p><div class="demo-text"><div><div class="demo-source clearfix"><pre><span style="color:#272">(</span><span style="color:#687868;font-weight:bold">ns</span> <span style="color:#5050c0;font-weight:bold">example</span>
  <span style="color:#940">(</span><span style="color:blue">:require</span> <span style="color:#44a">[</span>reagent.core <span style="color:blue">:as</span> r<span style="color:#44a">]</span><span style="color:#940">)</span><span style="color:#272">)</span></pre></div></div><p>We start with the basics: The clock is built out of
         cells, with a light colour if the bit the cell corresponds to
         is set.</p><div><div class="demo-source clearfix"><pre><span style="color:#272">(</span><span style="color:#687868;font-weight:bold">defn</span> <span style="color:#5050c0;font-weight:bold">cell</span> <span style="color:#940">[</span>n bit<span style="color:#940">]</span>
  <span style="color:#940">[</span><span style="color:blue">:div.clock-cell</span> <span style="color:#44a">{</span><span style="color:blue">:class</span> <span style="color:#272">(</span><span style="color:#687868;font-weight:bold">if</span> <span style="color:#940">(</span><span style="color:#687868;font-weight:bold">bit-test</span> n bit<span style="color:#940">)</span>
                             <span style="color:green">&quot;light&quot;</span>
                             <span style="color:green">&quot;dark&quot;</span><span style="color:#272">)</span><span style="color:#44a">}</span><span style="color:#940">]</span><span style="color:#272">)</span></pre></div></div><p>Cells are combined into columns of four bits, with a
         decimal digit at the bottom.</p><div><div class="demo-source clearfix"><pre><span style="color:#272">(</span><span style="color:#687868;font-weight:bold">defn</span> <span style="color:#5050c0;font-weight:bold">column</span> <span style="color:#940">[</span>n<span style="color:#940">]</span>
  <span style="color:#940">[</span><span style="color:blue">:div.clock-col</span>
   <span style="color:#44a">[</span>cell n 3<span style="color:#44a">]</span>
   <span style="color:#44a">[</span>cell n 2<span style="color:#44a">]</span>
   <span style="color:#44a">[</span>cell n 1<span style="color:#44a">]</span>
   <span style="color:#44a">[</span>cell n 0<span style="color:#44a">]</span>
   <span style="color:#44a">[</span><span style="color:blue">:div.clock-cell</span> n<span style="color:#44a">]</span><span style="color:#940">]</span><span style="color:#272">)</span></pre></div></div><p>Columns are in turn combined into pairs:</p><div><div class="demo-source clearfix"><pre><span style="color:#272">(</span><span style="color:#687868;font-weight:bold">defn</span> <span style="color:#5050c0;font-weight:bold">column-pair</span> <span style="color:#940">[</span>n<span style="color:#940">]</span>
  <span style="color:#940">[</span><span style="color:blue">:div.clock-pair</span>
   <span style="color:#44a">[</span>column <span style="color:#272">(</span><span style="color:#687868;font-weight:bold">quot</span> n 10<span style="color:#272">)</span><span style="color:#44a">]</span>
   <span style="color:#44a">[</span>column <span style="color:#272">(</span><span style="color:#687868;font-weight:bold">mod</span> n 10<span style="color:#272">)</span><span style="color:#44a">]</span><span style="color:#940">]</span><span style="color:#272">)</span></pre></div></div><p>We&#x27;ll also need the legend on the left side:</p><div><div class="demo-source clearfix"><pre><span style="color:#272">(</span><span style="color:#687868;font-weight:bold">defn</span> <span style="color:#5050c0;font-weight:bold">legend</span> <span style="color:#940">[</span>&amp; items<span style="color:#940">]</span>
  <span style="color:#940">(</span><span style="color:#687868;font-weight:bold">into</span> <span style="color:#44a">[</span><span style="color:blue">:div.clock-col.clock-legend</span><span style="color:#44a">]</span>
        <span style="color:#44a">(</span><span style="color:#687868;font-weight:bold">map</span> <span style="color:#272">(</span><span style="color:#687868;font-weight:bold">partial</span> <span style="color:#687868;font-weight:bold">vector</span> <span style="color:blue">:div.clock-cell</span><span style="color:#272">)</span>
             items<span style="color:#44a">)</span><span style="color:#940">)</span><span style="color:#272">)</span></pre></div></div><p>We combine these element into a component that shows the
         legend, hours, minutes and seconds; and optionally 1/100
         seconds. It also responds to clicks.</p><div><div class="demo-source clearfix"><pre><span style="color:#272">(</span><span style="color:#687868;font-weight:bold">defn</span> <span style="color:#5050c0;font-weight:bold">clock</span> <span style="color:#940">[</span>date show-100s toggle-100s<span style="color:#940">]</span>
  <span style="color:#940">[</span><span style="color:blue">:div.clock-main</span> <span style="color:#44a">{</span><span style="color:blue">:on-click</span> toggle-100s
                    <span style="color:blue">:class</span> <span style="color:#272">(</span><span style="color:#687868;font-weight:bold">when</span> show-100s <span style="color:green">&quot;wide&quot;</span><span style="color:#272">)</span><span style="color:#44a">}</span>
   <span style="color:#44a">[</span>legend 8 4 2 1<span style="color:#44a">]</span>
   <span style="color:#44a">[</span>column-pair <span style="color:#272">(</span>.getHours date<span style="color:#272">)</span><span style="color:#44a">]</span>
   <span style="color:#44a">[</span>column-pair <span style="color:#272">(</span>.getMinutes date<span style="color:#272">)</span><span style="color:#44a">]</span>
   <span style="color:#44a">[</span>column-pair <span style="color:#272">(</span>.getSeconds date<span style="color:#272">)</span><span style="color:#44a">]</span>
   <span style="color:#44a">(</span><span style="color:#687868;font-weight:bold">when</span> show-100s
     <span style="color:#272">[</span>column-pair <span style="color:#940">(</span><span style="color:#687868;font-weight:bold">-&gt;</span> <span style="color:#44a">(</span>.getMilliseconds date<span style="color:#44a">)</span>
                      <span style="color:#44a">(</span><span style="color:#687868;font-weight:bold">quot</span> 10<span style="color:#44a">)</span><span style="color:#940">)</span><span style="color:#272">]</span><span style="color:#44a">)</span><span style="color:#940">]</span><span style="color:#272">)</span></pre></div></div><p>We also need to keep track of the time, and of the
         detail shown, in a Reagent atom. And a function to update the
         time.</p><div><div class="demo-source clearfix"><pre><span style="color:#272">(</span><span style="color:#687868;font-weight:bold">def</span> <span style="color:#5050c0;font-weight:bold">clock-state</span> <span style="color:#940">(</span><span style="color:#687868;font-weight:bold">r/atom</span> <span style="color:#44a">{</span><span style="color:blue">:time</span> <span style="color:#272">(</span><span style="color:#687868;font-weight:bold">js/Date.</span><span style="color:#272">)</span>
                          <span style="color:blue">:show-100s</span> <span style="color:#687868;font-weight:bold">false</span><span style="color:#44a">}</span><span style="color:#940">)</span><span style="color:#272">)</span>

<span style="color:#272">(</span><span style="color:#687868;font-weight:bold">defn</span> <span style="color:#5050c0;font-weight:bold">update-time</span> <span style="color:#940">[</span><span style="color:#940">]</span>
  <span style="color:#940">(</span><span style="color:#687868;font-weight:bold">swap!</span> clock-state <span style="color:#687868;font-weight:bold">assoc</span> <span style="color:blue">:time</span> <span style="color:#44a">(</span><span style="color:#687868;font-weight:bold">js/Date.</span><span style="color:#44a">)</span><span style="color:#940">)</span><span style="color:#272">)</span></pre></div></div><p>And finally we use the <code>clock</code> component.
         The current time is scheduled to be updated, after a suitable
         delay, every time the main component is rendered (<code>reagent.core/next-tick</code> is just a front for <code>requestAnimationFrame</code>):</p><div><div class="demo-source clearfix"><pre><span style="color:#272">(</span><span style="color:#687868;font-weight:bold">defn</span> <span style="color:#5050c0;font-weight:bold">main</span> <span style="color:#940">[</span><span style="color:#940">]</span>
  <span style="color:#940">(</span><span style="color:#687868;font-weight:bold">let</span> <span style="color:#44a">[</span><span style="color:#272">{</span><span style="color:blue">:keys</span> <span style="color:#940">[</span>time show-100s<span style="color:#940">]</span><span style="color:#272">}</span> @clock-state<span style="color:#44a">]</span>
    <span style="color:#44a">(</span><span style="color:#687868;font-weight:bold">if</span> show-100s
      <span style="color:#272">(</span><span style="color:#687868;font-weight:bold">r/next-tick</span> update-time<span style="color:#272">)</span>
      <span style="color:#272">(</span><span style="color:#687868;font-weight:bold">js/setTimeout</span> update-time 1000<span style="color:#272">)</span><span style="color:#44a">)</span>
    <span style="color:#44a">[</span>clock time show-100s
     #<span style="color:#272">(</span><span style="color:#687868;font-weight:bold">swap!</span> clock-state <span style="color:#687868;font-weight:bold">update-in</span> <span style="color:#940">[</span><span style="color:blue">:show-100s</span><span style="color:#940">]</span> <span style="color:#687868;font-weight:bold">not</span><span style="color:#272">)</span><span style="color:#44a">]</span><span style="color:#940">)</span><span style="color:#272">)</span></pre></div></div><p>The entire source is also available <a href="https://github.com/reagent-project/reagent/blob/master/demo/reagentdemo/news/binaryclock.cljs">here</a>.</p><h2>How it all works</h2><p>Reading through the source, it may look like the entire
         clock component is recreated from scratch whenever the time
         changes. </p><p>That is an illusion: Reagent and React together
         makes sure that only the parts of the DOM that actually need
         to change are updated. For example, the <code>column-pair</code> function corresponding to hours only
         runs once every hour.</p><p>And that’s what makes Reagent and React fast. Try
         clicking on the clock to toggle the display of 1/100th
         seconds. Most browsers should have no trouble at all keeping
         up (even if they won’t actually show every 1/100th second:
         they are typically limited to roughly 60 fps).</p><p>But it is a very handy illusion. Almost the entire UI is
         made up of pure functions, transforming immutable data into
         other immutable data structures. That makes them easy to
         reason about, and trivial to test. You don’t have to care
         about ”model objects”, or about how to update the DOM
         efficiently. </p><p>Just pass arguments to component functions, return a UI
         description that corresponds to those arguments, and leave it
         to React to actually display that UI.</p></div></div></div><a href="https://github.com/reagent-project/reagent" class="github-badge"><img style="position:absolute;top:0;left:0;border:0" alt="Fork me on GitHub" src="https://s3.amazonaws.com/github/ribbons/forkme_left_orange_ff7600.png"/></a></div></div></div><script>var pageConfig = {"page-path":"/news/binary-clock.html"}</script><script src="js/main.js?8a4830" type="text/javascript"></script></body></html>